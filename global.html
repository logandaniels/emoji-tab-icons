<!DOCTYPE HTML>
<html>
<head>
<title>global HTML page</title>
<script type="text/javascript">

var defaultSettings = {
    sites : [
      {
        hostname: "google.com",
        emoji: "\uD83D\uDD0D" // magnifying glass
      },
      {
        hostname : "mail.google.com",
        emoji : "\uD83D\uDCEC" // mailbox
      },
      { hostname : "youtube.com",
        emoji : "\uD83C\uDFA5" // movie camera
      },
      { hostname : "stackoverflow.com",
        emoji : "\uD83D\uDCBB" // computer
      }
    ],
    defaultTabIcon : "\uD83C\uDF10", // 'internet' globe
    showDefaultTabIcon : false
}

if (safari.extension.settings["firstRun"] === "true") {
  for (var key in defaultSettings) {
    safari.extension.settings[key] = defaultSettings[key];
  }
  safari.extension.settings["firstRun"] = "false";
}

function getSettings() {
  var settings = {};
  Object.getOwnPropertyNames(safari.extension.settings).forEach(function(settingName) {
    settings[settingName] = safari.extension.settings[settingName];
  });
  return settings;
}

function setSettings(newSettings) {
  for (var key in newSettings) {
    if (key === "openSettings") {
      continue;
    }
    safari.extension.settings[key] = newSettings[key];
  }
  // Update settings in all open tabs
  sendMessageToAllTabs("getSettings", getSettings());
}

function sendMessageToAllTabs(message, data) {
    var bw = safari.application.activeBrowserWindow;
    for (var i = 0; i < bw.tabs.length; i++) {
      var tab = bw.tabs[i];
      tab.page.dispatchMessage(message, data);
    }
}

function getSiteSettings(hostname) {
  for (var i = 0; i < safari.extension.settings.sites.length; i++) {
    if (safari.extension.settings.sites[i].hostname == hostname) {
      return safari.extension.settings.sites[i];
    }
  }
  return null;
}

function openSettings() {
  var bw = safari.application.activeBrowserWindow;
  var tab = bw.openTab("foreground");
  tab.url = safari.extension.baseURI + "settings.html";

  // Remove listener while we reset the openSettings setting to
  // avoid triggering an infinite loop.
  safari.extension.settings.removeEventListener("change", handleSettingsChange);
  safari.extension.settings.openSettings = false;
  safari.extension.settings.addEventListener("change", handleSettingsChange);
}
  

safari.application.addEventListener("message", function(event) {
    var bw = safari.application.activeBrowserWindow;
    switch (event.name) {
        case "getSiteSettings":
            event.target.page.dispatchMessage("getSiteSettings", getSiteSettings(event.message));
            break;
        case "getSettings":
            event.target.page.dispatchMessage("getSettings", getSettings());
            break;
        case "setSettings":
            setSettings(event.message);
            break;
    }
}, false);

function handleSettingsChange(event) {
  switch (event.key) {
    case "openSettings":
      openSettings();
      break;
  }
}

safari.extension.settings.addEventListener("change", handleSettingsChange, false);

</script>
</head>
<body>
</body>
</html>
