<!DOCTYPE HTML>
<html>
<head>
<title>Emoji Tab Icons Settings</title>

<!-- Bootstrap and jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

<!--Handlebars for templating-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>

<!-- Emoji picker styles -->
<link href="emoji-picker/css/nanoscroller.css" rel="stylesheet">
<link href="emoji-picker/css/emoji.css" rel="stylesheet">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

<script type="text/x-handlebars-template" id="site-entry-template">
  <tr class="site-row" data-site-name="{{siteName}}">
    <td class="site-name-cell">{{siteName}}</td>
    <td><div style="position: relative"><input class="input-lg emoji-container" data-emojiable="true" type="text"></td></div>
    <td>
      <button type="button" class="close" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </td>
  </tr>
</script>

<style>
.table {
  border: 1px solid #dddddd;
}

.emoji-wysiwyg-editor {
  overflow: hidden !important;
}

.space-top {
  margin-top: 40px;
}

.editor-disabled {
  opacity: .5;
}
</style>

<script type="text/javascript">

var settings = {sites : [{hostname: "google.com", emoji: "lol"}, {hostname: "youtube.com", emoji: "ayy"}]};
var gettingInitialSettings = true;

function applySettings() {
  // Checkboxes
  $("#show-default-icon-checkbox").prop("checked", settings.showDefaultTabIcon);
  var emojiEditor = $("#show-default-icon-input").next();
  emojiEditor.html(settings.defaultTabIcon);
  emojiEditor.on("blur keyup paste", function(event) {
    settings.defaultTabIcon = $("#show-default-icon-input").val();
  });

  if (settings.showDefaultTabIcon) {
    $("#show-default-icon-input").parent().removeClass("editor-disabled");
  }

  // Site settings table
  var container = $("#sites-table-body");
  var sites = settings.sites;

  container.empty();
  for (var i = 0; i < sites.length; i++) {
    var container = $("#sites-table-body");
    var args = {
      siteName: sites[i].hostname
    };
    container.append(Handlebars.compile($("#site-entry-template").html())(args));
  }

  window.emojiPicker.discover();

  for (var i = 0; i < sites.length; i++) {
    // Set initial icon text
    var row = $('.site-row[data-site-name="' + sites[i].hostname + '"]');
    row.find(".emoji-wysiwyg-editor").first().html(sites[i].emoji);

    attachSiteListeners(sites[i].hostname);
  }
}

function addSiteButtonPressed() {
  var hostname = $("#add-site-input").val();
  if (getSiteSettings(hostname)) {
    // An entry for this site already exists
    return;
  }
  var container = $("#sites-table-body");
  var args = {
    siteName: hostname
  };
  container.append(Handlebars.compile($("#site-entry-template").html())(args));
  window.emojiPicker.discover();
  attachSiteListeners(hostname);
  $("#add-site-input").val("");

  settings.sites.push({hostname: hostname, emoji: ""});
}

function attachSiteListeners(hostname) {
    var row = $('.site-row[data-site-name="' + hostname + '"]');

    // Add a listener for clicking the delete button on the row
    row.find("button").on("click", function(event) {
        removeSite(hostname);
    });

    // Update site emoji whenever the text area is changed
    row.find('[contenteditable="true"]').on("blur keyup paste", function(event) {
        var site = getSiteSettings(hostname);
        site.emoji = getInputIconText(hostname);
    });
}

function removeSite(hostname) {
  settings.sites = settings.sites.filter(function(el) {
    return el.hostname != hostname;
  });
  var row = $('.site-row[data-site-name="' + hostname + '"]').remove();
}

function getSiteSettings(hostname) {
  for (var i = 0; i < settings.sites.length; i++) {
    if (settings.sites[i].hostname == hostname) {
      return settings.sites[i];
    }
  }
  return null;
}

function getInputIconText(hostname) {
  var row = $('.site-row[data-site-name="' + hostname + '"]');
  return row.find("input").val();
}


function validateSettings() {
    return true;
}

function saveSettings() {
  /*if (false && !validateSettings()) {
    var resultNode = document.getElementById("settings-result");
    resultNode.classList.remove("success");
    resultNode.classList.add("failure");
    resultNode.innerText = "Unable to save settings. Please fix any errors and try again.";
    return;
  }*/

  safari.self.tab.dispatchMessage("setSettings", settings);

  /*
  var resultNode = document.getElementById("settings-result");
  resultNode.classList.remove("failure");
  resultNode.classList.add("success");
  resultNode.innerText = "Settings saved.";
  */
}

function onDefaultIconCheckboxChanged(event) {
  if (event.target.checked) {
    $("#show-default-icon-input").parent().removeClass("editor-disabled");
    settings.showDefaultTabIcon = true;
    
  } else {
    $("#show-default-icon-input").parent().addClass("editor-disabled");
    settings.showDefaultTabIcon = false;
  }
}


safari.self.addEventListener("message", function(event) {
    switch (event.name) {
      case "getSettings":
          if (gettingInitialSettings) {
            settings = event.message;
            applySettings();
            gettingInitialSettings = false;
          }
        break;
    }
}, false);



window.addEventListener("load", function () {
  // Get initial settings
  safari.self.tab.dispatchMessage("getSettings");

  // Add listeners
  $("#add-site-button").on("click", function (event) {
    addSiteButtonPressed();
  });
  $("#save-button").on("click", function () { saveSettings();});
  $("#show-default-icon-checkbox").on("change", onDefaultIconCheckboxChanged);
});

</script>


</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-md-6 clearfix col-centered">
          <h1>Emoji Tab Icons <small>| Settings</small></h1>
          <hr>
          <div class="checkbox">
            <label>
                <input id="show-default-icon-checkbox" type="checkbox">Show default tab icon:
            </label>
            <div class="editor-disabled" style="display: inline-block; width:100px; position: relative">
              <input id="show-default-icon-input" type="text" data-emojiable="true" disabled>
            </div>
          </div>
          <div class="clearfix"></div>
          <div class="checkbox pull-left clearfix">
            <label>
              <input type="checkbox">Suppress tab icon in history
            </label>
          </div>
          <div class="clearfix"></div>
          <div class="space-top">
            <table class="table table-striped">
              <thead id="sites-table-header">
                <tr><th>URL</th><th>Icon</th><th></th></tr>
              </thead>
              <tbody id="sites-table-body">
              </tbody>
            </table>
          </div>
          <div class="clearfix">
          <div class="pull-right">
            <input id="add-site-input" type="text">
            <button id="add-site-button" type="button" class="btn btn-primary btn-sm">Add site</button>
          </div>
          <div class="clearfix"></div>
          <div class="space-top pull-right">
            <button id="save-button" type="button" class="btn btn-default btn-sm">Save settings</button>
          </div>
          </div>
      </div>
    </div>
  </div>

<!-- Emoji picker scripts -->
<script src="emoji-picker/js/nanoscroller.min.js"></script>
<script src="emoji-picker/js/tether.min.js"></script>
<script src="emoji-picker/js/config.js"></script>
<script src="emoji-picker/js/util.js"></script>
<script src="emoji-picker/js/jquery.emojiarea.js"></script>
<script src="emoji-picker/js/emoji-picker.js"></script>
 <script>
    $(function() {
      window.emojiPicker = new EmojiPicker({
        emojiable_selector: '[data-emojiable=true]',
        assetsPath: 'emoji-picker/img/',
        popupButtonClasses: 'fa fa-smile-o'
      });
      window.emojiPicker.discover();
    });
</script>
</body>
</html>
